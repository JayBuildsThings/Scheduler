<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduler - Expedition Planner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=Fira+Sans:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- LZ-String for URL Compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

    <style>
        body {
            font-family: 'Fira Sans', sans-serif;
            background-color: #f5f5f4; /* Stone-100 */
        }
        h1, h2, h3, button {
            font-family: 'Outfit', sans-serif;
        }
        .topo-bg {
            background-color: #f5f5f4;
            background-image: 
                radial-gradient(#d6d3d1 1px, transparent 1px),
                radial-gradient(#d6d3d1 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #e7e5e4;
        }
        ::-webkit-scrollbar-thumb {
            background: #a8a29e;
            border-radius: 5px;
            border: 2px solid #e7e5e4;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #78716c;
        }
        .animate-slide-up {
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Adventure Inputs */
        .adventure-input {
            transition: all 0.2s;
            border-bottom-width: 2px;
        }
        .adventure-input:focus {
            border-color: #d97706; /* Amber-600 */
            box-shadow: none;
        }
    </style>
</head>
<body class="text-stone-800 h-screen flex flex-col topo-bg overflow-hidden">

    <!-- Header -->
    <header class="bg-emerald-900 text-white shadow-lg z-10 relative overflow-hidden">
        <!-- decorative circle -->
        <div class="absolute -right-10 -top-10 w-32 h-32 bg-emerald-800 rounded-full opacity-50"></div>
        
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-18 py-4 flex justify-between items-center relative z-10">
            <div class="flex items-center gap-3">
                <div class="bg-amber-500 text-emerald-900 p-2 rounded-lg shadow-md transform -rotate-3">
                    <i class="fa-solid fa-compass text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold tracking-tight" id="headerTitle">Scheduler</h1>
                    <div class="text-xs text-emerald-200 font-medium tracking-wider uppercase">Expedition Planner</div>
                </div>
            </div>
            <div class="flex gap-3 items-center">
                <button onclick="app.resetApp()" class="text-sm text-emerald-200 hover:text-white hover:underline transition">
                    New Journey
                </button>
                <button id="shareBtn" onclick="app.copyLink()" class="hidden bg-amber-500 hover:bg-amber-400 text-emerald-950 px-5 py-2 rounded-full text-sm font-bold transition flex items-center gap-2 shadow-lg transform hover:-translate-y-0.5 active:translate-y-0">
                    <i class="fa-solid fa-share-nodes"></i> Share Map
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-hidden relative">
        
        <!-- VIEW 1: SETUP WIZARD -->
        <div id="setupView" class="absolute inset-0 flex items-center justify-center p-4 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 animate-slide-up border-t-4 border-amber-500 relative">
                <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-2 rounded-full shadow-sm border border-stone-100">
                    <i class="fa-solid fa-map-location-dot text-3xl text-emerald-600"></i>
                </div>

                <h2 class="text-3xl font-bold mb-2 text-center text-emerald-950 mt-4">Start an Adventure</h2>
                <p class="text-stone-500 mb-8 text-center">Where is your team heading? Set the coordinates.</p>
                
                <div class="space-y-6">
                    <!-- Group Name -->
                    <div>
                        <label class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-1">Adventure Name</label>
                        <input type="text" id="setupName" placeholder="e.g. Mountain Trek 2025" class="adventure-input w-full bg-stone-50 border-0 border-b-2 border-stone-200 rounded-t-md px-4 py-3 focus:bg-amber-50 focus:border-amber-500 outline-none text-lg font-semibold text-stone-800 placeholder-stone-400">
                    </div>

                    <!-- Date Range -->
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-1">Kickoff Date</label>
                            <input type="date" id="setupStart" class="adventure-input w-full bg-stone-50 border-0 border-b-2 border-stone-200 rounded-t-md px-4 py-3 focus:bg-amber-50 focus:border-amber-500 outline-none font-medium">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-1">Duration (Days)</label>
                            <input type="number" id="setupDays" value="7" min="1" max="30" class="adventure-input w-full bg-stone-50 border-0 border-b-2 border-stone-200 rounded-t-md px-4 py-3 focus:bg-amber-50 focus:border-amber-500 outline-none font-medium">
                        </div>
                    </div>

                    <!-- Places Definition -->
                    <div class="bg-stone-50 p-4 rounded-lg border border-stone-200">
                        <label class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-3">Waypoints / Locations</label>
                        <div id="placeList" class="space-y-2 mb-3">
                            <!-- Dynamic inputs -->
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="newPlaceInput" placeholder="Add location (e.g. Base Camp)" class="flex-1 bg-white border border-stone-300 rounded-md px-3 py-2 text-sm focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none" onkeypress="if(event.key === 'Enter') app.addSetupPlace()">
                            <button onclick="app.addSetupPlace()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-md transition shadow-sm">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <button onclick="app.initializeGroup()" class="w-full bg-emerald-800 hover:bg-emerald-900 text-white py-4 rounded-lg font-bold text-lg shadow-lg transition transform active:scale-[0.98] flex justify-center items-center gap-2 group">
                        Create Itinerary <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW 2: MAIN GRID -->
        <div id="gridView" class="hidden absolute inset-0 flex flex-col">
            
            <!-- Toolbar -->
            <div class="bg-white/80 backdrop-blur-md border-b border-stone-200 px-4 sm:px-8 py-4 flex flex-col sm:flex-row justify-between items-center gap-4 z-10">
                
                <!-- Legend / Palette -->
                <div class="flex items-center gap-3 overflow-x-auto max-w-full pb-2 sm:pb-0 no-scrollbar" id="legendContainer">
                    <!-- Legend items injected here -->
                </div>

                <!-- Add User Action -->
                <div class="flex gap-0 shadow-sm rounded-md">
                    <input type="text" id="newUserName" placeholder="Explorer Name" class="flex-1 sm:w-48 border border-stone-300 rounded-l-md px-4 py-2 text-sm focus:border-amber-500 focus:ring-1 focus:ring-amber-500 outline-none bg-white">
                    <button onclick="app.addUser()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-r-md text-sm font-bold whitespace-nowrap transition border-l border-emerald-700">
                        Join <i class="fa-solid fa-user-plus ml-1"></i>
                    </button>
                </div>
            </div>

            <!-- Scrollable Grid Area -->
            <div class="flex-1 overflow-auto p-4 sm:p-8 pb-20">
                <div class="bg-white rounded-lg shadow-xl border border-stone-200 overflow-hidden min-w-max mx-auto">
                    <table class="border-collapse w-full" id="scheduleTable">
                        <!-- Table generated by JS -->
                    </table>
                </div>
                
                <div class="mt-8 max-w-2xl mx-auto bg-amber-50 border border-amber-100 rounded-lg p-5 flex gap-4 items-start shadow-sm">
                    <div class="text-amber-600 mt-1 text-xl"><i class="fa-solid fa-map-signs"></i></div>
                    <div class="text-sm text-amber-900">
                        <strong class="font-bold font-display">Exploration Guide:</strong>
                        <p class="mt-1">Data is stored in your compass (the URL). No central server.</p>
                        <ol class="list-decimal ml-4 mt-2 space-y-1 text-amber-800">
                            <li>Tap cells to mark your location.</li>
                            <li>Click <span class="font-bold text-amber-700">"Share Map"</span> to generate a new coordinate link.</li>
                            <li>Send the new link to your fellow explorers.</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Add Waypoint Modal -->
    <div id="waypointModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-stone-900/40 backdrop-blur-sm p-4 opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 border-t-4 border-emerald-500 transform scale-95 transition-transform duration-200" id="modalContent">
            <h3 class="text-lg font-bold text-emerald-950 mb-2 font-display">New Destination</h3>
            <p class="text-stone-500 text-sm mb-4">Where is the team heading next?</p>
            
            <input type="text" id="modalPlaceInput" class="w-full bg-stone-50 border border-stone-200 rounded-lg px-4 py-2 mb-4 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none font-medium text-stone-700" placeholder="e.g. Hidden Waterfall" onkeypress="if(event.key === 'Enter') app.confirmAddPlace()">
            
            <div class="flex justify-end gap-2">
                <button onclick="app.closeModal()" class="px-4 py-2 text-stone-500 hover:bg-stone-100 rounded-lg text-sm font-medium transition">Cancel</button>
                <button onclick="app.confirmAddPlace()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold shadow-md transition transform active:scale-95">Add Location</button>
            </div>
        </div>
    </div>

    <!-- CUSTOM DROPDOWN MENU -->
    <div id="cellMenu" class="hidden fixed z-50 w-48 bg-white/95 backdrop-blur-xl rounded-xl shadow-2xl border border-stone-200 py-1 transform transition-all duration-200 origin-top-left ring-1 ring-black/5">
        <!-- Menu items injected by JS -->
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 translate-y-24 bg-emerald-900 text-white px-6 py-3 rounded-full shadow-2xl transition-transform duration-300 flex items-center gap-3 z-50 border border-emerald-700">
        <i class="fa-solid fa-circle-check text-emerald-400"></i>
        <span id="toastMsg" class="font-medium">Action Successful</span>
    </div>

<script>
/**
 * APP LOGIC
 * State managed via URL Hash using LZ-String compression.
 */

// Adventurous Earth/Nature Tones
const COLORS = [
    { bg: 'bg-stone-100', text: 'text-stone-400', border: 'border-stone-200', hex: '#f5f5f4' }, // Default/Empty
    { bg: 'bg-emerald-100', text: 'text-emerald-800', border: 'border-emerald-200', hex: '#d1fae5' },
    { bg: 'bg-amber-100', text: 'text-amber-800', border: 'border-amber-200', hex: '#fef3c7' },
    { bg: 'bg-sky-100', text: 'text-sky-800', border: 'border-sky-200', hex: '#e0f2fe' },
    { bg: 'bg-rose-100', text: 'text-rose-800', border: 'border-rose-200', hex: '#ffe4e6' },
    { bg: 'bg-violet-100', text: 'text-violet-800', border: 'border-violet-200', hex: '#ede9fe' },
    { bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-200', hex: '#ffedd5' },
    { bg: 'bg-lime-100', text: 'text-lime-800', border: 'border-lime-200', hex: '#ecfccb' },
    { bg: 'bg-cyan-100', text: 'text-cyan-800', border: 'border-cyan-200', hex: '#cffafe' },
];

const app = {
    state: {
        title: '',
        startDate: '',
        days: 7,
        places: [], 
        users: []
    },
    
    tempPlaces: ['Base Camp', 'Summit'], 

    init() {
        const hash = window.location.hash.substring(1);
        if (hash) {
            try {
                const decompressed = LZString.decompressFromEncodedURIComponent(hash);
                if (decompressed) {
                    this.state = JSON.parse(decompressed);
                    this.loadMainView();
                } else {
                    this.loadSetupView();
                }
            } catch (e) {
                console.error("Failed to load state", e);
                this.loadSetupView();
            }
        } else {
            this.loadSetupView();
        }
        document.getElementById('setupStart').valueAsDate = new Date();

        // Global click listener to close menu
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('cellMenu');
            if (!menu.contains(e.target) && !e.target.closest('td')) {
                this.closeMenu();
            }
        });
    },

    /* --- VIEW MANAGEMENT --- */
    
    loadSetupView() {
        document.getElementById('setupView').classList.remove('hidden');
        document.getElementById('gridView').classList.add('hidden');
        document.getElementById('shareBtn').classList.add('hidden');
        this.renderSetupPlaces();
    },

    loadMainView() {
        document.getElementById('setupView').classList.add('hidden');
        document.getElementById('gridView').classList.remove('hidden');
        document.getElementById('shareBtn').classList.remove('hidden');
        document.getElementById('headerTitle').innerText = this.state.title || 'Scheduler';
        this.renderLegend();
        this.renderGrid();
    },

    resetApp() {
        if(confirm("Start a new expedition? Current map data will be lost if not saved.")) {
            window.location.hash = '';
            window.location.reload();
        }
    },

    /* --- SETUP WIZARD LOGIC --- */

    renderSetupPlaces() {
        const container = document.getElementById('placeList');
        container.innerHTML = '';
        this.tempPlaces.forEach((place, index) => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between bg-white px-3 py-2 rounded border border-stone-200 shadow-sm';
            div.innerHTML = `
                <span class="text-sm font-bold text-stone-700"><i class="fa-solid fa-location-dot text-emerald-500 mr-2"></i>${place}</span>
                <button onclick="app.removeSetupPlace(${index})" class="text-stone-300 hover:text-red-500 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            `;
            container.appendChild(div);
        });
    },

    addSetupPlace() {
        const input = document.getElementById('newPlaceInput');
        const val = input.value.trim();
        if (val) {
            this.tempPlaces.push(val);
            input.value = '';
            this.renderSetupPlaces();
        }
    },

    removeSetupPlace(index) {
        this.tempPlaces.splice(index, 1);
        this.renderSetupPlaces();
    },

    initializeGroup() {
        const title = document.getElementById('setupName').value.trim() || 'My Adventure';
        const start = document.getElementById('setupStart').value;
        const days = parseInt(document.getElementById('setupDays').value) || 7;

        if (this.tempPlaces.length === 0) {
            alert("Please add at least one waypoint.");
            return;
        }

        this.state = {
            title: title,
            startDate: start,
            days: days,
            places: ['Unset', ...this.tempPlaces], 
            users: []
        };

        this.updateURL();
        this.loadMainView();
    },

    /* --- MAIN GRID LOGIC --- */

    renderLegend() {
        const container = document.getElementById('legendContainer');
        container.innerHTML = '';

        for (let i = 1; i < this.state.places.length; i++) {
            const placeName = this.state.places[i];
            const style = COLORS[i % COLORS.length];
            
            const badge = document.createElement('div');
            badge.className = `flex items-center gap-2 px-4 py-1.5 rounded-full border ${style.bg} ${style.border} ${style.text} text-xs font-bold whitespace-nowrap shadow-sm select-none cursor-default`;
            badge.innerHTML = `<i class="fa-solid fa-location-pin text-xs opacity-70"></i>${placeName}`;
            container.appendChild(badge);
        }

        // Add "New Place" button
        const addBtn = document.createElement('button');
        addBtn.className = "flex items-center gap-2 px-4 py-1.5 rounded-full border-2 border-dashed border-stone-300 text-stone-400 hover:text-emerald-700 hover:border-emerald-500 hover:bg-emerald-50 text-xs font-bold whitespace-nowrap transition-all group";
        addBtn.innerHTML = `<i class="fa-solid fa-plus group-hover:rotate-90 transition-transform"></i> Add Waypoint`;
        addBtn.onclick = () => this.addNewPlace();
        container.appendChild(addBtn);
    },

    addNewPlace() {
        const modal = document.getElementById('waypointModal');
        const content = document.getElementById('modalContent');
        const input = document.getElementById('modalPlaceInput');
        
        modal.classList.remove('hidden');
        // Small delay to allow display:block to apply before opacity transition
        requestAnimationFrame(() => {
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
            input.focus();
        });
    },

    closeModal() {
        const modal = document.getElementById('waypointModal');
        const content = document.getElementById('modalContent');
        
        modal.classList.add('opacity-0');
        content.classList.remove('scale-100');
        content.classList.add('scale-95');
        
        setTimeout(() => {
            modal.classList.add('hidden');
            document.getElementById('modalPlaceInput').value = '';
        }, 200);
    },

    confirmAddPlace() {
        const input = document.getElementById('modalPlaceInput');
        const name = input.value.trim();
        
        if (name) {
            if (this.state.places.some(p => p.toLowerCase() === name.toLowerCase())) {
                this.showToast("Waypoint already exists!", true);
                input.focus();
                return;
            }
            
            this.state.places.push(name);
            this.updateURL();
            this.renderLegend();
            this.showToast("Waypoint added to map!");
            this.closeModal();
        } else {
            input.focus();
        }
    },

    renderGrid() {
        const table = document.getElementById('scheduleTable');
        table.innerHTML = '';

        const dateObjs = this.generateDates();
        
        // 1. Header Row
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        const corner = document.createElement('th');
        corner.className = "p-4 text-left min-w-[180px] bg-stone-100 sticky left-0 z-20 border-b-2 border-stone-300";
        corner.innerHTML = '<span class="text-xs font-black uppercase tracking-widest text-stone-400">Explorer</span>';
        headerRow.appendChild(corner);

        dateObjs.forEach(d => {
            const th = document.createElement('th');
            th.className = "p-2 text-center min-w-[80px] border-b-2 border-stone-300 bg-stone-50";
            
            const isWeekend = d.dayName === 'Sat' || d.dayName === 'Sun';
            const textClass = isWeekend ? 'text-amber-600' : 'text-stone-500';
            const bgClass = isWeekend ? 'bg-amber-50 rounded-t-md' : '';

            th.innerHTML = `
                <div class="flex flex-col py-1 ${bgClass}">
                    <span class="text-[10px] font-bold uppercase tracking-wide ${textClass}">${d.dayName}</span>
                    <span class="text-xl font-black text-stone-800 leading-none">${d.dayNum}</span>
                </div>
            `;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // 2. User Rows
        const tbody = document.createElement('tbody');
        
        if (this.state.users.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="${this.state.days + 1}" class="p-12 text-center text-stone-400 italic bg-white">
                <div class="flex flex-col items-center gap-2">
                    <i class="fa-regular fa-compass text-4xl opacity-20"></i>
                    <span>No explorers yet. Join the expedition above!</span>
                </div>
            </td>`;
            tbody.appendChild(tr);
        } else {
            this.state.users.forEach((user, userIndex) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-stone-50 transition-colors group border-b border-stone-100";

                // User Name Cell
                const nameTd = document.createElement('td');
                nameTd.className = "p-3 bg-white sticky left-0 z-10 border-r border-stone-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]";
                nameTd.innerHTML = `
                    <div class="flex items-center justify-between group/item pl-2">
                        <div class="font-bold text-stone-700 font-display text-sm">${user.name}</div>
                        <button onclick="app.removeUser(${userIndex})" class="opacity-0 group-hover/item:opacity-100 text-stone-300 hover:text-red-500 transition px-2">
                            <i class="fa-solid fa-trash-can text-xs"></i>
                        </button>
                    </div>
                `;
                tr.appendChild(nameTd);

                // Schedule Cells
                user.schedule.forEach((placeIndex, dayIndex) => {
                    const td = document.createElement('td');
                    const isUnset = placeIndex === 0;
                    const colorStyle = isUnset ? COLORS[0] : COLORS[placeIndex % COLORS.length];
                    
                    td.className = `p-1 border-r border-stone-100 cursor-pointer text-center h-14 relative bg-white`;
                    
                    const cellContent = document.createElement('div');
                    // Removed select-none to ensure clicks register well
                    cellContent.className = `w-full h-full rounded-md flex items-center justify-center text-xs font-bold transition-all transform hover:scale-[1.05] active:scale-95 shadow-sm ${colorStyle.bg} ${colorStyle.text}`;
                    
                    if (!isUnset) {
                        cellContent.innerHTML = `<span>${this.state.places[placeIndex]}</span>`;
                    } else {
                        // Changed + to a chevron to imply dropdown
                        cellContent.innerHTML = '<span class="opacity-0 group-hover/cell:opacity-100 text-stone-300"><i class="fa-solid fa-chevron-down"></i></span>';
                        td.classList.add('group/cell'); // Add group for hover effect
                    }

                    // Updated click handler to open menu
                    td.onclick = (e) => this.openMenu(e, userIndex, dayIndex);
                    
                    td.appendChild(cellContent);
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        table.appendChild(tbody);
    },

    generateDates() {
        const dates = [];
        const start = new Date(this.state.startDate);
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        for (let i = 0; i < this.state.days; i++) {
            const d = new Date(start);
            d.setDate(start.getDate() + i);
            dates.push({
                dayName: days[d.getDay()],
                dayNum: d.getDate(),
                fullDate: d.toISOString().split('T')[0]
            });
        }
        return dates;
    },

    /* --- INTERACTION LOGIC --- */

    addUser() {
        const input = document.getElementById('newUserName');
        const name = input.value.trim();
        if (!name) {
            this.showToast("Please enter a name", true);
            return;
        }
        if (this.state.users.some(u => u.name.toLowerCase() === name.toLowerCase())) {
            this.showToast("Explorer already exists!", true);
            return;
        }
        const emptySchedule = new Array(this.state.days).fill(0);
        this.state.users.push({ name: name, schedule: emptySchedule });
        input.value = '';
        this.updateURL();
        this.renderGrid();
        this.showToast(`${name} joined!`);
    },

    removeUser(index) {
        if(confirm(`Remove ${this.state.users[index].name} from the expedition?`)) {
            this.state.users.splice(index, 1);
            this.updateURL();
            this.renderGrid();
        }
    },

    /* --- DROPDOWN MENU LOGIC --- */

    activeCell: null, // { userIndex, dayIndex }

    openMenu(e, userIndex, dayIndex) {
        e.stopPropagation(); // Prevent document click from closing immediately
        this.activeCell = { userIndex, dayIndex };
        
        const menu = document.getElementById('cellMenu');
        const rect = e.currentTarget.getBoundingClientRect();
        
        // Generate Menu Content
        menu.innerHTML = '';
        
        // Header (Date)
        const date = this.generateDates()[dayIndex];
        const header = document.createElement('div');
        header.className = "px-4 py-2 border-b border-stone-100 text-[10px] font-bold uppercase tracking-widest text-stone-400 bg-stone-50/50 rounded-t-xl";
        header.innerText = `${date.dayName}, ${date.dayNum}`;
        menu.appendChild(header);

        // Options
        this.state.places.forEach((place, index) => {
            const btn = document.createElement('button');
            const isSelected = this.state.users[userIndex].schedule[dayIndex] === index;
            const style = COLORS[index % COLORS.length];
            
            btn.className = `w-full text-left px-4 py-2.5 text-sm font-medium hover:bg-stone-50 transition-colors flex items-center gap-3 ${isSelected ? 'bg-stone-50' : ''}`;
            
            // Dot indicator
            const dotClass = index === 0 ? 'border border-stone-300 bg-transparent' : style.bg.replace('bg-', 'bg-');
            const dotColor = index === 0 ? '' : style.text.replace('text-', 'bg-'); // rough way to get a solid color
            
            // Custom bullet styling
            let iconHtml = '';
            if (index === 0) {
                iconHtml = `<div class="w-2.5 h-2.5 rounded-full border-2 border-stone-300"></div>`;
            } else {
                // Use the defined hex color or fallback class
                iconHtml = `<div class="w-2.5 h-2.5 rounded-full ${style.bg} border ${style.border}"></div>`;
            }

            btn.innerHTML = `
                ${iconHtml}
                <span class="${index === 0 ? 'text-stone-400 italic' : 'text-stone-700'}">${index === 0 ? 'Clear Selection' : place}</span>
                ${isSelected ? '<i class="fa-solid fa-check text-emerald-500 ml-auto text-xs"></i>' : ''}
            `;
            
            btn.onclick = () => this.selectPlace(index);
            menu.appendChild(btn);
        });

        // Positioning
        menu.classList.remove('hidden');
        
        // Check if menu goes off screen bottom
        const menuHeight = Math.min(this.state.places.length * 40 + 40, 300); // Approx height
        const spaceBelow = window.innerHeight - rect.bottom;
        
        if (spaceBelow < menuHeight) {
            // Show above cell
            menu.style.top = `${rect.top - menu.offsetHeight}px`;
            menu.style.transformOrigin = 'bottom left';
        } else {
            // Show below cell
            menu.style.top = `${rect.bottom + 5}px`;
            menu.style.transformOrigin = 'top left';
        }
        
        // Check right edge
        if (rect.left + 192 > window.innerWidth) { // 192px is w-48
            menu.style.left = `${rect.right - 192}px`;
            menu.style.transformOrigin = menu.style.transformOrigin.replace('left', 'right');
        } else {
            menu.style.left = `${rect.left}px`;
        }

        // Animate in
        menu.style.opacity = '0';
        menu.style.transform = 'scale(0.95)';
        requestAnimationFrame(() => {
            menu.style.opacity = '1';
            menu.style.transform = 'scale(1)';
        });
    },

    closeMenu() {
        const menu = document.getElementById('cellMenu');
        menu.style.opacity = '0';
        menu.style.transform = 'scale(0.95)';
        setTimeout(() => {
            menu.classList.add('hidden');
            this.activeCell = null;
        }, 200);
    },

    selectPlace(placeIndex) {
        if (!this.activeCell) return;
        const { userIndex, dayIndex } = this.activeCell;
        
        this.state.users[userIndex].schedule[dayIndex] = placeIndex;
        
        this.updateURL();
        this.renderGrid();
        this.closeMenu();
    },

    // Replaced toggleCell with openMenu logic above
    // toggleCell(userIndex, dayIndex) { ... } // REMOVED

    updateURL() {
        const json = JSON.stringify(this.state);
        const compressed = LZString.compressToEncodedURIComponent(json);
        history.replaceState(null, null, '#' + compressed);
    },

    copyLink() {
        this.updateURL();
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            this.showToast("Map coordinates copied!");
        }).catch(err => {
            this.showToast("Failed to copy", true);
        });
    },

    showToast(msg, isError = false) {
        const toast = document.getElementById('toast');
        const msgSpan = document.getElementById('toastMsg');
        const icon = toast.querySelector('i');
        msgSpan.innerText = msg;
        if (isError) {
            icon.className = "fa-solid fa-circle-exclamation text-red-400";
        } else {
            icon.className = "fa-solid fa-circle-check text-emerald-400";
        }
        toast.classList.remove('translate-y-24');
        setTimeout(() => {
            toast.classList.add('translate-y-24');
        }, 3000);
    }
};

window.onload = () => app.init();
</script>
</body>
</html>
