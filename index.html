<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expedition Scheduler</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Outfit for display, Fira Sans for body -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=Fira+Sans:wght@400;500&display=swap" rel="stylesheet">

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- LZ-String for URL Compression (Key for saving/loading state) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

    <style>
        body {
            font-family: 'Fira Sans', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray for a clean look */
        }
        h1, h2, h3, button, .font-display {
            font-family: 'Outfit', sans-serif;
        }
        .topo-bg {
            /* Subtle topographic background pattern */
            background-color: #f0f4f8;
            background-image:
                radial-gradient(#d6d3d1 1px, transparent 1px),
                radial-gradient(#d6d3d1 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
        .grid-header-col {
            min-width: 150px;
        }
        .grid-cell {
            min-width: 100px; /* Ensures cell size is readable */
            min-height: 50px;
            cursor: pointer;
        }
    </style>
</head>

<body class="p-4 sm:p-8 topo-bg min-h-screen">
    <div id="app" class="max-w-7xl mx-auto">

        <!-- Header and Controls -->
        <header class="mb-8 p-6 bg-white rounded-xl shadow-lg border-b-4 border-indigo-500">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2 font-display">Expedition Scheduler</h1>
            <p class="text-gray-500 mb-4">Plan user schedules across multiple days and destinations.</p>

            <div class="flex flex-wrap gap-3">
                <button onclick="app.copyLink()"
                    class="flex items-center space-x-2 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out">
                    <i class="fa-solid fa-link"></i>
                    <span>Copy Shareable Link</span>
                </button>
                <button onclick="app.showConfirmation('Are you sure you want to reset ALL data? This cannot be undone.', app.resetState.bind(app))"
                    class="flex items-center space-x-2 px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150 ease-in-out">
                    <i class="fa-solid fa-trash-can"></i>
                    <span>Reset All</span>
                </button>
            </div>
        </header>

        <main class="grid lg:grid-cols-3 gap-8">
            <!-- Left Column: The Schedule Grid -->
            <div class="lg:col-span-2 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Schedule Grid</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="scheduleGrid">
                        <!-- Grid content will be rendered here -->
                    </table>
                </div>
            </div>

            <!-- Right Column: User and Place Management -->
            <div class="space-y-8">
                <!-- User Management Card -->
                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 flex justify-between items-center">
                        Users
                        <button onclick="app.addUser()" title="Add New User"
                            class="text-green-500 hover:text-green-700 transition duration-150">
                            <i class="fa-solid fa-circle-plus fa-lg"></i>
                        </button>
                    </h2>
                    <ul id="userList" class="space-y-3">
                        <!-- User list will be rendered here -->
                    </ul>
                </div>

                <!-- Place Management Card -->
                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 flex justify-between items-center">
                        Places
                        <button onclick="app.addPlace()" title="Add New Place"
                            class="text-green-500 hover:text-green-700 transition duration-150">
                            <i class="fa-solid fa-circle-plus fa-lg"></i>
                        </button>
                    </h2>
                    <ul id="placeList" class="space-y-3">
                        <!-- Place list will be rendered here -->
                    </ul>
                </div>

                <!-- Day Management Card -->
                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 flex justify-between items-center">
                        Days
                        <button onclick="app.addDay()" title="Add New Day"
                            class="text-green-500 hover:text-green-700 transition duration-150">
                            <i class="fa-solid fa-circle-plus fa-lg"></i>
                        </button>
                    </h2>
                    <ul id="dayList" class="space-y-3">
                        <!-- Day list will be rendered here -->
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- --- Floating Components --- -->

    <!-- Place Selection Menu (Context Menu) -->
    <div id="placeMenu" class="fixed hidden z-50 p-2 bg-white rounded-lg shadow-xl border border-gray-200 transform -translate-x-1/2 -translate-y-1/2 transition duration-100" style="top: 0; left: 0;">
        <div id="menuContent">
            <!-- Place options rendered here -->
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[100] hidden">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm mx-4">
            <h3 class="text-xl font-display font-bold mb-4 text-gray-800">Confirm Action</h3>
            <p id="confirmMessage" class="mb-6 text-gray-600"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="app.rejectConfirmation()"
                    class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button onclick="app.acceptConfirmation()"
                    class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-0 left-1/2 -translate-x-1/2 mb-4 p-4 flex items-center space-x-3 bg-gray-800 text-white rounded-xl shadow-lg border border-gray-700 transition duration-300 transform translate-y-24 z-50">
        <i class="fa-solid fa-circle-check text-emerald-400"></i>
        <span id="toastMsg" class="font-medium">Action successful!</span>
    </div>

    <script>
        const app = {
            // --- STATE MANAGEMENT ---
            state: {
                users: [
                    { id: 1, name: "User 1", color: "#6366f1", schedule: [] }, // Indigo-500
                ],
                places: [
                    { id: 101, name: "Base Camp", color: "#22c55e" }, // Emerald-500
                    { id: 102, name: "Exploration Zone Alpha", color: "#f97316" }, // Orange-500
                ],
                days: [
                    { id: 201, name: "Day 1" },
                    { id: 202, name: "Day 2" },
                ],
            },
            activeCell: null,
            confirmAction: null,

            // --- INITIALIZATION ---
            init() {
                this.loadFromURL();
                this.renderAll();

                // Listen for URL changes (e.g., back/forward button)
                window.addEventListener('popstate', () => this.loadFromURL());
            },

            // --- PERSISTENCE (URL HASH) ---

            loadFromURL() {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    try {
                        const decompressed = LZString.decompressFromEncodedURIComponent(hash);
                        if (decompressed) {
                            const loadedState = JSON.parse(decompressed);
                            this.state = loadedState;
                            this.renderAll();
                            this.showToast("State loaded from URL!");
                            return;
                        }
                    } catch (e) {
                        console.error("Error loading state from URL:", e);
                        // If loading fails, fall back to default/current state
                    }
                }
                // Initialize schedules to match the current number of days
                this.ensureScheduleSize();
            },

            updateURL() {
                // Remove the schedule content from user objects to keep the URL smaller,
                // but only if the schedule is all 0s (default place)
                const stateToCompress = JSON.parse(JSON.stringify(this.state)); // Deep copy
                
                // Ensure schedule length is correct before saving
                this.ensureScheduleSize(stateToCompress);

                const json = JSON.stringify(stateToCompress);
                const compressed = LZString.compressToEncodedURIComponent(json);
                history.replaceState(null, null, '#' + compressed);
            },

            copyLink() {
                this.updateURL();
                // Ensure the URL reflects the latest state before copying
                const url = window.location.href;

                // Use the older execCommand fallback for better cross-platform compatibility in some environments
                try {
                    const tempInput = document.createElement('textarea');
                    tempInput.value = url;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    this.showToast("Shareable link copied!");
                } catch (err) {
                    // Fallback to clipboard API if available, or show error
                    navigator.clipboard.writeText(url).then(() => {
                        this.showToast("Shareable link copied!");
                    }).catch(err => {
                        this.showToast("Failed to copy link. Please copy from the address bar.", true);
                    });
                }
            },

            resetState() {
                this.state = {
                    users: [
                        { id: 1, name: "User 1", color: "#6366f1", schedule: [] },
                    ],
                    places: [
                        { id: 101, name: "Base Camp", color: "#22c55e" },
                        { id: 102, name: "Exploration Zone Alpha", color: "#f97316" },
                        { id: 103, name: "Rest & Refuel", color: "#eab308" }
                    ],
                    days: [
                        { id: 201, name: "Day 1" },
                        { id: 202, name: "Day 2" },
                        { id: 203, name: "Day 3" }
                    ],
                };
                this.ensureScheduleSize();
                this.updateURL();
                this.renderAll();
                this.showToast("All data reset to defaults.");
            },

            // --- UTILITIES ---

            generateId() {
                return Date.now() + Math.floor(Math.random() * 1000);
            },

            // Ensures every user's schedule array is the same length as the days array
            ensureScheduleSize(state = this.state) {
                const daysCount = state.days.length;
                const defaultPlaceId = state.places[0] ? state.places[0].id : 0;

                state.users.forEach(user => {
                    while (user.schedule.length < daysCount) {
                        user.schedule.push(defaultPlaceId);
                    }
                    // Trim schedules if days were removed
                    user.schedule.length = daysCount;
                });
            },

            getPlaceById(id) {
                return this.state.places.find(p => p.id === id);
            },

            // --- RENDERING ---

            renderAll() {
                this.renderGrid();
                this.renderUserList();
                this.renderPlaceList();
                this.renderDayList();
            },

            renderGrid() {
                const gridTable = document.getElementById('scheduleGrid');
                if (!gridTable) return;

                const days = this.state.days;
                const users = this.state.users;
                let html = '';

                // Table Header (Days)
                html += '<thead><tr class="bg-gray-100">';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider grid-header-col">User</th>';
                days.forEach(day => {
                    html += `<th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">${day.name}</th>`;
                });
                html += '</tr></thead>';

                // Table Body (Users and Schedules)
                html += '<tbody class="divide-y divide-gray-200">';
                users.forEach((user, userIndex) => {
                    html += `<tr>`;
                    // User Name Column
                    html += `<td class="px-4 py-2 font-semibold text-gray-700 grid-header-col bg-gray-50">${user.name}</td>`;

                    // Schedule Cells
                    days.forEach((day, dayIndex) => {
                        const placeId = user.schedule[dayIndex];
                        const place = this.getPlaceById(placeId);
                        const placeColor = place ? place.color : '#cbd5e1'; // slate-300
                        const placeName = place ? place.name : 'Unassigned';

                        html += `
                            <td class="px-1 py-1 text-center" onclick="app.openMenu(${userIndex}, ${dayIndex}, event)">
                                <div class="grid-cell p-2 rounded-lg shadow-sm font-medium text-sm transition duration-150 hover:shadow-md border border-transparent"
                                     style="background-color: ${placeColor}; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.4);">
                                    ${placeName}
                                </div>
                            </td>
                        `;
                    });
                    html += `</tr>`;
                });
                html += '</tbody>';

                gridTable.innerHTML = html;
            },

            renderUserList() {
                const userList = document.getElementById('userList');
                if (!userList) return;

                userList.innerHTML = this.state.users.map((user, index) => `
                    <li class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border">
                        <i class="fa-solid fa-user-astronaut text-indigo-500"></i>
                        <input type="text" value="${user.name}" onchange="app.updateUser(${index}, 'name', this.value)"
                            class="flex-grow p-1 border-b border-gray-300 focus:border-indigo-500 outline-none text-gray-700 bg-transparent">
                        <button onclick="app.showConfirmation('Remove ${user.name} from the list?', app.removeUser.bind(app, ${index}))"
                            title="Remove User" class="text-red-400 hover:text-red-600 transition">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </li>
                `).join('');
            },

            renderPlaceList() {
                const placeList = document.getElementById('placeList');
                if (!placeList) return;

                placeList.innerHTML = this.state.places.map((place, index) => `
                    <li class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border">
                        <i class="fa-solid fa-map-location-dot" style="color: ${place.color};"></i>
                        <input type="text" value="${place.name}" onchange="app.updatePlace(${index}, 'name', this.value)"
                            class="flex-grow p-1 border-b border-gray-300 focus:border-indigo-500 outline-none text-gray-700 bg-transparent">
                        <input type="color" value="${place.color}" onchange="app.updatePlace(${index}, 'color', this.value)"
                            class="w-8 h-8 rounded-full border-none cursor-pointer">
                        <button onclick="app.showConfirmation('Remove place ${place.name} from the list?', app.removePlace.bind(app, ${index}))"
                            title="Remove Place" class="text-red-400 hover:text-red-600 transition">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </li>
                `).join('');
            },

            renderDayList() {
                const dayList = document.getElementById('dayList');
                if (!dayList) return;

                dayList.innerHTML = this.state.days.map((day, index) => `
                    <li class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border">
                        <i class="fa-solid fa-calendar-day text-teal-500"></i>
                        <input type="text" value="${day.name}" onchange="app.updateDay(${index}, 'name', this.value)"
                            class="flex-grow p-1 border-b border-gray-300 focus:border-indigo-500 outline-none text-gray-700 bg-transparent">
                        <button onclick="app.showConfirmation('Remove ${day.name} from the schedule?', app.removeDay.bind(app, ${index}))"
                            title="Remove Day" class="text-red-400 hover:text-red-600 transition">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </li>
                `).join('');
            },

            // --- USER ACTIONS ---

            addUser() {
                const newId = this.generateId();
                const newUser = {
                    id: newId,
                    name: `User ${this.state.users.length + 1}`,
                    color: "#6366f1",
                    schedule: Array(this.state.days.length).fill(this.state.places[0] ? this.state.places[0].id : 0),
                };
                this.state.users.push(newUser);
                this.ensureScheduleSize();
                this.updateURL();
                this.renderAll();
                this.showToast(`User ${newUser.name} added.`);
            },

            updateUser(index, key, value) {
                if (this.state.users[index]) {
                    this.state.users[index][key] = value;
                    this.updateURL();
                    this.renderAll();
                }
            },

            removeUser(index) {
                this.state.users.splice(index, 1);
                this.updateURL();
                this.renderAll();
                this.showToast("User removed.");
            },

            // --- PLACE ACTIONS ---

            addPlace() {
                const newId = this.generateId();
                const newPlace = {
                    id: newId,
                    name: `New Place`,
                    color: "#f59e0b" // Amber-500
                };
                this.state.places.push(newPlace);
                this.updateURL();
                this.renderAll();
                this.showToast(`Place ${newPlace.name} added.`);
            },

            updatePlace(index, key, value) {
                if (this.state.places[index]) {
                    this.state.places[index][key] = value;
                    this.updateURL();
                    this.renderAll();
                }
            },

            removePlace(index) {
                const placeIdToRemove = this.state.places[index].id;
                this.state.places.splice(index, 1);

                // Update all schedules to use the default place if the removed place was assigned
                const defaultPlaceId = this.state.places[0] ? this.state.places[0].id : 0;
                this.state.users.forEach(user => {
                    user.schedule = user.schedule.map(id => (id === placeIdToRemove ? defaultPlaceId : id));
                });

                this.updateURL();
                this.renderAll();
                this.showToast("Place removed and schedules updated.");
            },

            // --- DAY ACTIONS ---

            addDay() {
                const newId = this.generateId();
                const newDay = {
                    id: newId,
                    name: `Day ${this.state.days.length + 1}`,
                };
                this.state.days.push(newDay);
                this.ensureScheduleSize(); // Ensure all users get a new slot
                this.updateURL();
                this.renderAll();
                this.showToast(`Day ${newDay.name} added.`);
            },

            updateDay(index, key, value) {
                if (this.state.days[index]) {
                    this.state.days[index][key] = value;
                    this.updateURL();
                    this.renderAll();
                }
            },

            removeDay(index) {
                this.state.days.splice(index, 1);
                // Remove the corresponding day from every user's schedule
                this.state.users.forEach(user => {
                    if (index < user.schedule.length) {
                        user.schedule.splice(index, 1);
                    }
                });
                this.updateURL();
                this.renderAll();
                this.showToast("Day removed and schedules adjusted.");
            },

            // --- MENU ACTIONS ---

            openMenu(userIndex, dayIndex, event) {
                this.activeCell = { userIndex, dayIndex };
                const menu = document.getElementById('placeMenu');
                const menuContent = document.getElementById('menuContent');
                const rect = event.currentTarget.getBoundingClientRect();

                // Generate menu options
                menuContent.innerHTML = `
                    <p class="text-xs text-gray-500 uppercase font-semibold mb-2">Assign Place:</p>
                    ${this.state.places.map(place => `
                        <button onclick="app.assignPlace(${place.id})"
                            class="block w-full text-left px-3 py-1 rounded-md text-sm font-medium hover:bg-indigo-100 transition duration-100"
                            style="color: ${place.color};">
                            <i class="fa-solid fa-location-dot w-4"></i> ${place.name}
                        </button>
                    `).join('')}
                `;

                // Position the menu near the clicked cell
                menu.style.top = `${rect.top + rect.height / 2 + window.scrollY}px`;
                menu.style.left = `${rect.left + rect.width / 2 + window.scrollX}px`;
                menu.classList.remove('hidden');

                // Add event listener to close menu when clicking outside
                document.addEventListener('click', this.closeMenuHandler);
            },

            closeMenuHandler: (e) => {
                const menu = document.getElementById('placeMenu');
                // Check if the click was inside the menu or on a cell (to prevent immediate re-opening)
                if (menu && !menu.contains(e.target) && !e.target.closest('.grid-cell')) {
                    app.closeMenu();
                }
            },

            closeMenu() {
                document.getElementById('placeMenu').classList.add('hidden');
                document.removeEventListener('click', this.closeMenuHandler);
                this.activeCell = null;
            },

            assignPlace(placeIndex) {
                if (!this.activeCell) return;
                const { userIndex, dayIndex } = this.activeCell;

                // Update the schedule with the selected place ID
                this.state.users[userIndex].schedule[dayIndex] = placeIndex;

                this.updateURL();
                this.renderGrid();
                this.closeMenu();
            },


            // --- CONFIRMATION MODAL LOGIC ---

            showConfirmation(message, action) {
                this.confirmAction = action;
                document.getElementById('confirmMessage').innerText = message;
                document.getElementById('confirmationModal').classList.remove('hidden');
            },

            closeConfirmationModal() {
                document.getElementById('confirmationModal').classList.add('hidden');
            },

            acceptConfirmation() {
                if (this.confirmAction) {
                    this.confirmAction();
                }
                this.closeConfirmationModal();
                this.confirmAction = null;
            },

            rejectConfirmation() {
                this.closeConfirmationModal();
            },

            // --- TOAST LOGIC ---

            showToast(msg, isError = false) {
                const toast = document.getElementById('toast');
                const msgSpan = document.getElementById('toastMsg');
                const icon = toast.querySelector('i');

                // Change colors and icons based on error status
                if (isError) {
                    toast.classList.remove('bg-gray-800', 'border-gray-700');
                    toast.classList.add('bg-red-800', 'border-red-600');
                    icon.className = "fa-solid fa-circle-exclamation text-red-300";
                } else {
                    toast.classList.remove('bg-red-800', 'border-red-600');
                    toast.classList.add('bg-gray-800', 'border-gray-700');
                    icon.className = "fa-solid fa-circle-check text-emerald-400";
                }

                msgSpan.innerText = msg;

                // Show toast
                toast.classList.remove('translate-y-24');

                // Hide toast after 3 seconds
                setTimeout(() => {
                    toast.classList.add('translate-y-24');
                }, 3000);
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
