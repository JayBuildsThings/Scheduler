<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanIt - Group Scheduling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .cell-hover:hover { filter: brightness(95%); cursor: pointer; }
        .selected-place { border: 2px solid black; transform: scale(1.05); }
        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Specific styles for the Row View (Horizontal Scroll) */
        .row-view-container {
            max-width: 100%;
            overflow-x: auto;
            white-space: nowrap; /* Prevent elements inside from wrapping */
        }

        /* Fix the user column in Row View */
        .sticky-user-col {
            position: sticky;
            left: 0;
            z-index: 10; /* Above the date cells */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- APP CONTAINER -->
    <div id="app" class="flex-1 flex flex-col relative max-w-7xl mx-auto w-full bg-white shadow-xl h-full">
        
        <!-- HEADER -->
        <header class="bg-white border-b border-gray-200 p-4 flex justify-between items-center z-10">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.hash=''">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-calendar-days"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-gray-900" id="app-title">PlanIt</h1>
            </div>
            <div id="header-actions" class="flex gap-2">
                <!-- Dynamic Buttons injected here -->
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main id="main-content" class="flex-1 overflow-hidden relative">
            <!-- Views will be injected here via JS -->
            <div id="loading-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-50">
                <div class="loader mb-4"></div>
                <p class="text-gray-500">Connecting to scheduler...</p>
            </div>
        </main>

    </div>

    <!-- MODAL (Name Entry) -->
    <div id="name-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-2">Who are you?</h2>
            <p class="text-gray-500 mb-4">Enter your name so others know who is planning.</p>
            <input type="text" id="username-input" class="w-full border border-gray-300 p-3 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g. Alex">
            <button onclick="saveName()" id="join-schedule-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">Join Schedule</button>
        </div>
    </div>

    <!-- SUPABASE & LOGIC -->
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // --- 1. CONFIGURATION ---
        
        // !!! IMPORTANT: REPLACE THESE PLACEHOLDERS WITH YOUR ACTUAL SUPABASE PROJECT CREDENTIALS !!!
        // If you see an error like "Anonymous sign-ins are disabled," ensure these are correct 
        // AND that Anonymous Sign-in is enabled in your Supabase Auth Settings.
        const SUPABASE_URL = 'https://pjrzqqtinpyrxpisncom.supabase.co'; // e.g., 'https://abcdefg1234.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqcnpxcXRpbnB5cnhwaXNuY29tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMzI1MDksImV4cCI6MjA3OTYwODUwOX0.5sgpY5xqsxUa3tTjmXLBgr8PAk6Cg8G2sMgzj1qCkgw'; // e.g., 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'


        // Initialize Supabase Client
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global State
        let currentUserId = null;
        let currentGroupId = null;
        let groupData = { name: '', users: [], places: [], schedule: [] }; // Structured for SQL results
        let realtimeChannel = null;
        let selectedPlace = null; 
        let isAuthReady = false; 
        let viewMode = 'columns'; 
        
        // --- 2. AUTHENTICATION & INIT ---

        /**
         * Retries a function with exponential backoff.
         */
        async function retryWithBackoff(fn, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }


        /**
         * Logs in the user anonymously using Supabase Auth
         */
        async function initApp() {
            try {
                // Wrap sign-in in a retry block
                const authData = await retryWithBackoff(async () => {
                    const { data, error } = await supabase.auth.signInAnonymously();
                    if (error) {
                         // Check for the specific error message seen in your image
                        if (error.message.includes("Anonymous sign-ins are disabled")) {
                            throw new Error("Anonymous Sign-in Disabled. Check your Supabase Auth Settings.");
                        }
                        throw error;
                    }
                    return data;
                }, 3, 500); // 3 retries max, starting at 500ms
                
                currentUserId = authData.user.id;
                
                // Retrieve persisted view mode
                const storedViewMode = localStorage.getItem('planit_viewmode');
                if (storedViewMode) viewMode = storedViewMode;
                
                isAuthReady = true;
                document.getElementById('loading-screen').classList.add('hidden'); // Hide loading screen on successful auth
                handleRouting();

            } catch (error) {
                console.error("Auth Error:", error);
                document.getElementById('loading-screen').classList.remove('hidden'); // Ensure screen is visible for error
                let errorMessage = `Error connecting to Supabase: ${error.message}.`;
                
                if (error.message.includes("Anonymous Sign-in Disabled")) {
                    errorMessage += " Please enable Anonymous Sign-in in your Supabase Auth settings.";
                } else if (error.message.includes("Invalid key")) {
                     errorMessage += " Please check your SUPABASE_URL and SUPABASE_ANON_KEY.";
                }

                document.getElementById('loading-screen').innerHTML = `
                    <div class="p-10 text-center text-red-600 bg-red-50 rounded-xl shadow-lg m-4">
                        <p class="font-bold mb-2">Connection Failed</p>
                        <p class="text-sm">${errorMessage}</p>
                    </div>
                `;
            }
        }
        
        // --- 3. REALTIME & DATA FETCHING ---

        /**
         * Fetches all related data for a group and sets up a real-time listener.
         * @param {string} groupId 
         */
        async function loadGroupDataAndSubscribe(groupId) {
            if (realtimeChannel) {
                await supabase.removeChannel(realtimeChannel);
            }

            // 1. Setup Realtime Channel for the specific group
            realtimeChannel = supabase.channel(`group_${groupId}`)
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'schedule', 
                    filter: `group_id=eq.${groupId}` 
                }, fetchAndRender)
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'group_users', 
                    filter: `group_id=eq.${groupId}` 
                }, fetchAndRender)
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'places', 
                    filter: `group_id=eq.${groupId}` 
                }, fetchAndRender)
                .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'groups', 
                    filter: `id=eq.${groupId}` 
                }, fetchAndRender)
                .subscribe();

            // 2. Initial Fetch
            fetchAndRender();
            
            // Re-check username status after data load
            checkUserName();
        }

        /**
         * Fetches all related data for a group and updates the UI.
         */
        async function fetchAndRender() {
            document.getElementById('loading-screen').classList.remove('hidden');

            const [groupRes, usersRes, placesRes, scheduleRes] = await Promise.all([
                supabase.from('groups').select('*').eq('id', currentGroupId).single(),
                supabase.from('group_users').select('*').eq('group_id', currentGroupId),
                supabase.from('places').select('*').eq('group_id', currentGroupId).order('name', { ascending: true }),
                supabase.from('schedule').select('*').eq('group_id', currentGroupId)
            ]);

            document.getElementById('loading-screen').classList.add('hidden');

            if (groupRes.error || !groupRes.data) {
                console.error("Group fetch error:", groupRes.error);
                document.getElementById('main-content').innerHTML = `<div class="p-10 text-center text-red-500">Group not found or data error.</div>`;
                return;
            }

            // Transform data into the structure the renderer expects
            groupData = {
                id: groupRes.data.id,
                name: groupRes.data.name,
                users: usersRes.data || [],
                places: placesRes.data || [],
                schedule: scheduleRes.data || []
            };

            document.getElementById('app-title').textContent = groupData.name || 'PlanIt'; 
            renderScheduler();
        }
        
        // --- 4. ROUTING ---
        
        function handleRouting() {
            if (!isAuthReady) return; 

            const hash = window.location.hash.substring(1); 
            if (hash.startsWith('group/')) {
                const groupId = hash.split('/')[1];
                currentGroupId = groupId;
                loadGroupDataAndSubscribe(groupId);
            } else {
                loadLandingView();
            }
        }

        window.addEventListener('hashchange', handleRouting);

        // --- 5. VIEWS (Rendering logic remains mostly the same, data source changes) ---

        // LANDING PAGE
        function loadLandingView() {
            if (realtimeChannel) supabase.removeChannel(realtimeChannel); 
            currentGroupId = null;
            document.getElementById('app-title').textContent = 'PlanIt'; 
            
            const html = `
                <div class="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-blue-50 to-indigo-50">
                    <div class="max-w-lg w-full text-center space-y-8">
                        <div>
                            <h2 class="text-4xl font-extrabold text-gray-900 mb-2">Coordinate Simply.</h2>
                            <p class="text-lg text-gray-600">Create a group, share the link, and see where everyone is.</p>
                        </div>
                        
                        <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
                            <label class="block text-left text-sm font-medium text-gray-700 mb-2">Group Name</label>
                            <input type="text" id="new-group-name" 
                                class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-4 mb-6" 
                                placeholder="e.g. Berlin Trip, Office Schedule">
                            
                            <button onclick="window.createGroup()" 
                                class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-xl text-lg px-5 py-4 text-center transition shadow-lg shadow-blue-500/30">
                                Create New Group
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
            document.getElementById('header-actions').innerHTML = '';
        }

        // --- 6. ACTIONS (Adapted for Supabase) ---

        // Create Group
        window.createGroup = async () => {
            const name = document.getElementById('new-group-name').value;
            if (!name) return;
            
            const createButton = document.querySelector('#main-content button');
            let originalButtonHtml = createButton ? createButton.innerHTML : 'Create New Group';
            if (createButton) {
                createButton.disabled = true;
                createButton.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Creating...`;
            }


            try {
                // 1. Insert Group
                const { data: group, error: groupError } = await supabase
                    .from('groups')
                    .insert([{ name: name }])
                    .select('id')
                    .single();

                if (groupError) throw groupError;
                
                const newGroupId = group.id;

                // 2. Insert Default Places
                const defaultPlaces = [
                    { name: 'Office', color: 'bg-blue-100 text-blue-800 border-blue-200', group_id: newGroupId },
                    { name: 'Home', color: 'bg-green-100 text-green-800 border-green-200', group_id: newGroupId },
                    { name: 'Away', color: 'bg-orange-100 text-orange-800 border-orange-200', group_id: newGroupId }
                ];
                
                const { error: placesError } = await supabase
                    .from('places')
                    .insert(defaultPlaces);

                if (placesError) throw placesError;

                // 3. Success, redirect
                window.location.hash = `group/${newGroupId}`;

            } catch (e) {
                console.error("Error creating group:", e);
                
                // Restore button state
                if (createButton) {
                    createButton.disabled = false;
                    createButton.innerHTML = originalButtonHtml;
                }
                
                // Show a friendly error message on the UI
                document.getElementById('main-content').innerHTML = `
                    <div class="h-full flex items-center justify-center text-center p-8">
                        <div class="bg-red-50 border border-red-300 p-6 rounded-lg shadow-lg max-w-sm">
                            <h3 class="text-xl font-bold text-red-700 mb-3">Group Creation Failed</h3>
                            <p class="text-red-600 text-sm mb-3">
                                We could not create the group. This is usually caused by an RLS (Row Level Security) issue 
                                or incorrect Supabase credentials.
                            </p>
                            <p class="text-red-600 text-xs mb-3 font-mono break-all">${e.message || 'Unknown Error'}</p>
                            <button onclick="window.location.hash=''" class="mt-4 text-blue-600 hover:text-blue-800 font-medium">Go back to start</button>
                        </div>
                    </div>
                `;
            }
        };

        // User Name Logic
        function checkUserName() {
            const storedName = localStorage.getItem('planit_username');
            // Check if the current user ID is already registered in the group_users table for this group
            const isRegistered = groupData.users.some(u => u.user_id === currentUserId);
            
            // Show modal if name is not set OR if user is not yet registered in this group
            if (!storedName || !isRegistered) {
                document.getElementById('name-modal').classList.remove('hidden');
                // Pre-fill input if name is stored but registration failed previously
                if (storedName) {
                    document.getElementById('username-input').value = storedName;
                }
            } else {
                // IMPORTANT: Hide modal if user is registered and name is stored
                document.getElementById('name-modal').classList.add('hidden');
            }
        }

        // UPDATED: make async and wait for registration
        window.saveName = async () => {
            const name = document.getElementById('username-input').value.trim();
            if (!name) return;
            
            const joinButton = document.getElementById('join-schedule-button');
            joinButton.disabled = true;
            const originalText = joinButton.textContent;
            joinButton.textContent = 'Joining...';
            
            localStorage.setItem('planit_username', name);
            
            // Wait for the registration call to complete
            const success = await registerUserInGroup(name);
            
            joinButton.disabled = false;
            joinButton.textContent = originalText;
            
            if (success) {
                document.getElementById('name-modal').classList.add('hidden');
                // After successful registration, force a re-render to update the user list
                // and potentially hide the "you" flag correctly if it wasn't there before.
                fetchAndRender();
            } else {
                // If registration failed (e.g., RLS error), provide feedback
                console.error("Failed to register user, modal remains open.");
                alert("Failed to join the schedule. Please check the console for details.");
            }
        }

        async function registerUserInGroup(name) {
            if (!currentUserId || !currentGroupId) return false;
            
            const userData = {
                user_id: currentUserId,
                group_id: currentGroupId,
                display_name: name
            };
            
            console.log("Attempting to register user:", userData);

            // Use upsert to handle both insert (new user) and update (name change)
            const { error } = await supabase
                .from('group_users')
                .upsert(userData, { onConflict: 'user_id, group_id' });

            if (error) {
                console.error("Error registering user (RLS issue likely):", error);
                return false;
            }
            
            return true;
        }

        // Add Place
        window.addPlace = async () => {
            // Using a simple prompt as a temporary modal replacement
            const name = prompt("Enter name for new place:");
            if (!name) return;
            
            const colors = [
                'bg-purple-100 text-purple-800 border-purple-200',
                'bg-pink-100 text-pink-800 border-pink-200',
                'bg-yellow-100 text-yellow-800 border-yellow-200',
                'bg-teal-100 text-teal-800 border-teal-200',
                'bg-red-100 text-red-800 border-red-200',
                'bg-indigo-100 text-indigo-800 border-indigo-200'
            ];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            const newPlace = {
                group_id: currentGroupId,
                name: name,
                color: randomColor
            };

            const { error } = await supabase
                .from('places')
                .insert([newPlace]);

            if (error) {
                console.error("Error adding place:", error);
            }
        }

        // Copy Link
        window.copyLink = () => {
            const url = window.location.href;
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy'); 
            console.info("Link copied to clipboard! Send it to your group.");
        }

        // Select Tool/Place
        window.selectPlace = (placeId) => {
            selectedPlace = placeId;
            renderScheduler();
        }
        
        // Toggle View Mode
        window.setViewMode = (mode) => {
            viewMode = mode;
            localStorage.setItem('planit_viewmode', mode); 
            renderScheduler();
        }

        // Update Schedule Cell
        window.toggleCell = async (dateStr) => {
            if (!currentUserId || !currentGroupId || !selectedPlace) {
                console.warn("Select a place and ensure you are signed in.");
                return;
            }

            const currentDate = new Date(dateStr);
            const currentEntry = groupData.schedule.find(s => 
                s.user_id === currentUserId && formatDateKey(new Date(s.date)) === dateStr
            );
            
            let placeToSet = selectedPlace;
            let action;

            if (currentEntry) {
                // If clicking with the same tool, delete it (toggle off)
                if (currentEntry.place_id === selectedPlace) {
                    action = 'delete';
                } else {
                    // Update to new selected place
                    action = 'update';
                }
            } else {
                action = 'insert';
            }

            if (action === 'insert') {
                const { error } = await supabase
                    .from('schedule')
                    .insert([{ 
                        user_id: currentUserId, 
                        group_id: currentGroupId, 
                        date: dateStr, 
                        place_id: placeToSet 
                    }]);
                if (error) console.error("Error inserting schedule:", error);

            } else if (action === 'update') {
                const { error } = await supabase
                    .from('schedule')
                    .update({ place_id: placeToSet })
                    .match({ user_id: currentUserId, group_id: currentGroupId, date: dateStr });
                if (error) console.error("Error updating schedule:", error);

            } else if (action === 'delete') {
                const { error } = await supabase
                    .from('schedule')
                    .delete()
                    .match({ user_id: currentUserId, group_id: currentGroupId, date: dateStr });
                if (error) console.error("Error deleting schedule:", error);
            }
        }

        // --- 7. RENDERING HELPER FUNCTIONS ---
        
        function getDates() {
            const dates = [];
            const today = new Date();
            // Show last 2 days and next 12 days
            for(let i=-2; i<12; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                dates.push(d);
            }
            return dates;
        }

        function formatDateKey(date) {
            // Returns YYYY-MM-DD
            return date.toISOString().split('T')[0];
        }
        
        function renderToolbar(places) {
            return `
                <div class="bg-white border-b border-gray-200 p-4 flex gap-3 overflow-x-auto no-scrollbar items-center">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mr-2 flex-shrink-0">I am at:</span>
                    ${places.map(p => `
                        <button onclick="window.selectPlace('${p.id}')" 
                            class="${p.color} px-4 py-2 rounded-full border text-sm font-semibold whitespace-nowrap transition-all flex-shrink-0
                                ${selectedPlace === p.id ? 'ring-2 ring-offset-2 ring-gray-400 scale-105 shadow-md' : 'opacity-70 hover:opacity-100'}">
                            ${p.name}
                        </button>
                    `).join('')}
                    
                    <button onclick="window.addPlace()" title="Add New Place" class="w-8 h-8 flex items-center justify-center rounded-full border border-dashed border-gray-400 text-gray-400 hover:text-blue-500 hover:border-blue-500 transition flex-shrink-0">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    
                    <div class="ml-auto text-sm text-gray-500 hidden md:block flex-shrink-0">
                        Select a place, then tap the grid.
                    </div>
                </div>
            `;
        }

        // Horizontal Grid View (Desktop Default)
        function renderRowView(dates, users, schedule, places) {
            const myId = currentUserId;

            const renderDateHeaders = dates.map(d => {
                const isToday = d.toDateString() === new Date().toDateString();
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                return `
                    <div class="w-20 md:w-24 p-2 flex-shrink-0 text-center border-r border-gray-100 ${isToday ? 'bg-blue-50' : ''} ${isWeekend ? 'bg-gray-50' : ''}">
                        <div class="text-xs text-gray-400 uppercase font-bold">${d.toLocaleDateString('en-US', {weekday: 'short'})}</div>
                        <div class="text-sm font-bold text-gray-700 ${isToday ? 'text-blue-600' : ''}">${d.getDate()}</div>
                    </div>
                `;
            }).join('');

            const renderUserRows = users.map(user => {
                const isMe = myId === user.user_id;
                
                const renderCells = dates.map(d => {
                    const dateKey = formatDateKey(d);
                    
                    // Find schedule entry for this user and date
                    const scheduleEntry = schedule.find(s => 
                        s.user_id === user.user_id && formatDateKey(new Date(s.date)) === dateKey
                    );

                    const place = (scheduleEntry) ? places.find(p => p.id === scheduleEntry.place_id) : null;
                    
                    const isEditable = isMe;
                    const isToday = d.toDateString() === new Date().toDateString();
                    
                    return `
                        <div onclick="${isEditable ? `window.toggleCell('${dateKey}')` : ''}" 
                            class="w-20 md:w-24 h-14 md:h-16 flex-shrink-0 border-r border-gray-100 border-dotted relative flex items-center justify-center transition-all
                                ${isEditable ? 'cursor-pointer hover:bg-gray-100' : 'cursor-default'}
                                ${isToday ? 'bg-blue-50/30' : ''}
                            ">
                            
                            ${place ? `
                                <div class="${place.color} text-xs font-semibold px-2 py-1 rounded shadow-sm max-w-[90%] truncate text-center select-none pointer-events-none transform transition-transform group-hover:scale-105">
                                    ${place.name}
                                </div>
                            ` : `
                                ${isEditable && selectedPlace ? '<div class="opacity-30 text-gray-400 text-xs font-medium">Click to set</div>' : ''}
                            `}
                        </div>
                    `;
                }).join('');
                                        
                return `
                    <div class="flex border-b border-gray-100 hover:bg-gray-50 transition-colors group">
                        <!-- User Name Column -->
                        <div class="w-32 md:w-48 p-3 flex-shrink-0 border-r border-gray-200 flex items-center bg-white sticky-user-col shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-gray-200 to-gray-300 flex items-center justify-center text-gray-600 font-bold text-xs mr-3">
                                ${user.display_name.charAt(0).toUpperCase()}
                            </div>
                            <div class="truncate">
                                <div class="text-sm font-medium text-gray-900 truncate">${user.display_name} ${isMe ? '<span class="text-xs text-blue-500 bg-blue-50 px-1 rounded ml-1">(You)</span>' : ''}</div>
                            </div>
                        </div>

                        <!-- Date Cells -->
                        ${renderCells}
                    </div>
                `;
            }).join('');

            return `
                <div class="row-view-container">
                    <div class="inline-block min-w-full bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <!-- Header Row (Dates) -->
                        <div class="flex border-b border-gray-200">
                            <div class="w-32 md:w-48 p-3 flex-shrink-0 bg-gray-50 border-r border-gray-200 font-bold text-gray-500 text-sm flex items-center sticky-user-col">
                                Team Member
                            </div>
                            ${renderDateHeaders}
                        </div>
                        <!-- User Rows -->
                        ${renderUserRows}
                    </div>
                </div>
            `;
        }
        
        // Vertical/Mobile View (Transposed Grid)
        function renderColumnView(dates, users, schedule, places) {
            const myId = currentUserId;

            const renderDateColumns = dates.map(d => {
                const dateKey = formatDateKey(d);
                const isToday = d.toDateString() === new Date().toDateString();
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;

                const renderUserCards = users.map(user => {
                    const isMe = myId === user.user_id;
                    
                    // Find schedule entry for this user and date
                    const scheduleEntry = schedule.find(s => 
                        s.user_id === user.user_id && formatDateKey(new Date(s.date)) === dateKey
                    );
                    
                    const place = (scheduleEntry) ? places.find(p => p.id === scheduleEntry.place_id) : null;
                    const isEditable = isMe;
                    
                    return `
                        <div onclick="${isEditable ? `window.toggleCell('${dateKey}')` : ''}" 
                            class="p-3 mb-2 rounded-lg border flex justify-between items-center transition-all 
                            ${isEditable ? 'cursor-pointer hover:bg-gray-100' : 'cursor-default'} 
                            ${isMe ? 'bg-white border-blue-200' : 'bg-white border-gray-200'}">
                            
                            <!-- User Info -->
                            <div class="flex items-center">
                                <div class="w-7 h-7 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-xs mr-3 flex-shrink-0">
                                    ${user.display_name.charAt(0).toUpperCase()}
                                </div>
                                <div class="text-sm font-medium text-gray-900 truncate">${user.display_name} ${isMe ? '<span class="text-xs text-blue-500 ml-1">(You)</span>' : ''}</div>
                            </div>

                            <!-- Place Indicator (The Cell Content) -->
                            <div class="flex-shrink-0 ml-2">
                                ${place ? `
                                    <div class="${place.color} text-xs font-semibold px-2 py-1 rounded shadow-sm text-center select-none">
                                        ${place.name}
                                    </div>
                                ` : `
                                    ${isEditable && selectedPlace ? '<div class="text-sm text-blue-400">Click to set</div>' : '<div class="text-sm text-gray-300">?</div>'}
                                `}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="bg-white rounded-xl shadow-md p-4 mb-6 border ${isToday ? 'border-blue-400 shadow-lg' : 'border-gray-200'}">
                        <!-- Date Header -->
                        <div class="pb-3 mb-3 border-b ${isToday ? 'border-blue-200' : 'border-gray-200'}">
                            <h3 class="text-lg font-bold ${isToday ? 'text-blue-600' : 'text-gray-800'}">
                                ${d.toLocaleDateString('en-US', {weekday: 'long'})}
                            </h3>
                            <p class="text-sm text-gray-500">${d.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})} ${isWeekend ? 'â€” Weekend' : ''}</p>
                        </div>
                        
                        <!-- User Cards (The Transposed Row) -->
                        <div>
                            ${renderUserCards}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="max-w-md mx-auto w-full">
                    ${renderDateColumns}
                </div>
            `;
        }

        // --- 8. MAIN RENDER FUNCTION ---

        function renderScheduler() {
            if (!groupData.id) return;
            
            // Header Actions
            const actionsDiv = document.getElementById('header-actions');
            actionsDiv.innerHTML = `
                <!-- View Toggle -->
                <div class="inline-flex rounded-lg shadow-sm bg-gray-100 p-0.5 border border-gray-200">
                    <button onclick="window.setViewMode('columns')" title="Mobile-Friendly Vertical View" class="px-3 py-1 text-sm font-medium rounded-lg transition ${viewMode === 'columns' ? 'bg-white text-blue-600 shadow-md' : 'text-gray-500 hover:bg-gray-200'}">
                        <i class="fa-solid fa-grip-vertical"></i> Columns
                    </button>
                    <button onclick="window.setViewMode('rows')" title="Desktop Horizontal Grid View" class="px-3 py-1 text-sm font-medium rounded-lg transition ${viewMode === 'rows' ? 'bg-white text-blue-600 shadow-md' : 'text-gray-500 hover:bg-gray-200'}">
                        <i class="fa-solid fa-grip-lines"></i> Rows
                    </button>
                </div>
                
                <button onclick="window.copyLink()" class="flex items-center gap-2 bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg hover:bg-indigo-200 transition font-medium text-sm">
                    <i class="fa-solid fa-link"></i> <span>Invite</span>
                </button>
            `;

            const dates = getDates();
            const users = groupData.users || [];
            const schedule = groupData.schedule || [];
            const places = groupData.places || [];

            // Sort users by name for consistent display
            users.sort((a, b) => {
                // Keep 'You' at the top
                if (a.user_id === currentUserId) return -1;
                if (b.user_id === currentUserId) return 1;
                return a.display_name.localeCompare(b.display_name);
            });

            let html = `
                <div class="flex flex-col h-full">
                    <!-- TOOLBAR (Places) -->
                    ${renderToolbar(places)}
                    
                    <!-- SCHEDULER VIEW -->
                    <div class="flex-1 overflow-auto bg-gray-50 p-4">
                        ${viewMode === 'columns' 
                            ? renderColumnView(dates, users, schedule, places) 
                            : renderRowView(dates, users, schedule, places)
                        }
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }

        // Start
        // Ensure the loading screen is immediately visible before starting auth
        document.getElementById('loading-screen').classList.remove('hidden');
        initApp();

    </script>
</body>
</html>
